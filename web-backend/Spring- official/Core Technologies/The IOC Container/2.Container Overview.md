# 📖 Container Overview

该文档描述了 Spring 框架的核心，没有涉及Spring boot 的技术。

${\large {\color[RGB]{250, 157, 30}容器概述}} $
容器即 Spring IOC 容器。它负责了实例化、配置和组装 bean。
在 Spring 框架中 它是由 org.springframework.context.ApplicationContext 接口定义的。

${\large {\color[RGB]{250, 157, 30}重要机制}} $

1. **实例定义的核心：** 配置元数据（CML、Java 注解、Java  代码等）

2. **容器读取实例配置：** 容器实现上述几种类型配置元数据的读取

3. **创建容器实例：** 不需要明确用户代码实例化 Spring IOC 容器的一个或多个实例。例如，在Web应用场景中，通常只需在应用程序的 `web.xml` 文件中编写8行（或更多）模板式的Web描述符就足够了

   ```xml
   <context-param>
       <param-name>contextConfigLocation</param-name>
       <param-value>/WEB-INF/daoContext.xml /WEB-INF/applicationContext.xml</param-value>
   </context-param>
   
   <listener>
       <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
   </listener>
   
   ```

   <img src="https://raw.githubusercontent.com/ChenXuRiYue/image-cloud/main/typora/container-magic.png" alt="container magic" style="zoom: 67%;" />

   如上图表达了 Spring 工作方式 的高层视图。

   1. 应用程序类
   2. 配置元数据
   3. Spring IOC 容器

   这样在 ApplicationContext 被创建或者初始化之后，就拥有了一个安全配置好的可执行系统或应用程序。

${\large {\color[RGB]{250, 157, 30}配置元数据}} $

**配置元数据**代表了你，作为一个应用开发者，如何告诉Spring容器在你的应用中实例化、配置和组装对象。

**XML** 格式是出配置元数据传统的、最直观的方式。**基于Java 配置元数据**是目前主流的配置方式。

${\normalsize{\color[RGB]{253, 175, 14}XML配置元数据}}$
```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="..." class="..."> (1) (2)
        <!-- 这个bean的合作者和配置在这里 -->
    </bean>

    <bean id="..." class="...">
        <!-- c这个bean的合作者和配置在这里 -->
    </bean>

    <!-- 更多bean 定义在这里 -->

</beans>

```

${\large {\color[RGB]{250, 157, 30} 实例化一个容器}} $

提供给 `ApplicationContext` 构造函数的一条或多条路径是资源字符串，它让容器从各种外部资源（如本地文件系统、Java `CLASSPATH` 等）加载配置元数据。

${\normalsize{\color[RGB]{253, 175, 14}XML配置元数据}}$

```java
ApplicationContext context = new ClassPathXmlApplicationContext("services.xml", "daos.xml");
```

**service.xml 示例**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- services -->

    <bean id="petStore" class="org.springframework.samples.jpetstore.services.PetStoreServiceImpl">
        <property name="accountDao" ref="accountDao"/>
        <property name="itemDao" ref="itemDao"/>
        <!-- additional collaborators and configuration for this bean go here -->
    </bean>

    <!-- more bean definitions for services go here -->

</beans>
```

**daos.xml 示例**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="accountDao"
        class="org.springframework.samples.jpetstore.dao.jpa.JpaAccountDao">
        <!-- additional collaborators and configuration for this bean go here -->
    </bean>

    <bean id="itemDao" class="org.springframework.samples.jpetstore.dao.jpa.JpaItemDao">
        <!-- additional collaborators and configuration for this bean go here -->
    </bean>

    <!-- more bean definitions for data access objects go here -->

</beans>
```

每次增加一个类都要修改上述配置文件。不难想象当一个项目的 $Bean$ 成千上万，每次在窗口开多个 xml 文件时使用体验会很糟糕。

如果 一个xml 文件配置非常庞大。可以 **构建基于 XML 的配置元数据**。即每个单独的 XML 配置文件代表了架构中的一个逻辑层或模块：

```xml
<beans>
    <import resource="services.xml"/>
    <import resource="resources/messageSource.xml"/>
    <import resource="/resources/themeSource.xml"/>

    <bean id="bean1" class="..."/>
    <bean id="bean2" class="..."/>
</beans>
```

${\normalsize{\color[RGB]{253, 175, 14}Groovy \  Bean \ Definition \ DSL}}$

```java
ApplicationContext context = new GenericGroovyApplicationContext("beans.groovy");
```

作为外部化配置元数据的另一个例子，Bean定义也可以用Spring的Groovy Bean Definition DSL来表达。
通常情况下，这种配置存在于 ".groovy" 文件中，其结构如下例所示。

```groovy
beans {
    dataSource(BasicDataSource) {
        driverClassName = "org.hsqldb.jdbcDriver"
        url = "jdbc:hsqldb:mem:grailsDB"
        username = "sa"
        password = ""
        settings = [mynew:"setting"]
    }
    sessionFactory(SessionFactory) {
        dataSource = dataSource
    }
    myService(MyService) {
        nestedBean = { AnotherBean bean ->
            dataSource = dataSource
        }
    }
}
```

${\Large {\color[RGB]{250, 157, 30} 使用容器}} $

`pplicationContext` 是一个高级工厂的接口，能够维护不同Bean及其依赖关系的注册表。通过使用方法 `T getBean(String name, Class<T> requiredType)`，你可以检索到Bean的实例。

```java
// 检索配置的实例
PetStoreService service = context.getBean("petStore", PetStoreService.class);

// 使用配置的实例
List<String> userList = service.getUsernameList();
```



`ApplicationContext` 接口还有其他一些检索Bean的方法，但理想情况下，你的应用代码不应该使用这些方法。事实上，你的应用程序代码根本就不应该调用 `getBean()` 方法，因此对Spring的API根本就没有依赖性。
