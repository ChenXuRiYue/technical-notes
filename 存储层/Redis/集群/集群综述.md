### Redis 分布式模式的业务背景

#### 高并发访问需求

在互联网应用中，尤其是电商、社交、游戏等领域，往往会面临大量用户的同时访问。例如，电商平台在促销活动期间，会有海量的用户同时进行商品浏览、下单等操作；社交平台在热门话题出现时，会有大量用户同时刷新动态、评论和点赞。单机 Redis 无法承受如此高的并发请求，而分布式 Redis 可以将请求分散到多个节点上，提高系统的并发处理能力。

#### 海量数据存储需求

随着业务的发展，数据量会不断增长。例如，视频平台需要存储大量的视频元数据、用户观看记录等；金融机构需要存储海量的交易记录和用户信息。单机 Redis 的内存容量有限，无法满足海量数据的存储需求，分布式 Redis 可以通过数据分片将数据分散存储在多个节点上，实现大规模数据的存储。

#### 高可用性需求

对于一些关键业务系统，如支付系统、订单系统等，要求系统具有极高的可用性，不能出现长时间的停机。单机 Redis 存在单点故障问题，一旦出现故障，整个系统将无法正常工作。分布式 Redis 通过主从复制、故障转移等机制，可以在节点出现故障时自动进行切换，保证系统的高可用性。

### Redis 分布式模式提供的高可用、高一致性方案

#### 主从复制

- **原理**：主从复制是 Redis 实现高可用的基础机制。一个主节点可以有多个从节点，主节点负责处理写操作，从节点负责处理读操作。主节点将写操作产生的数据变更同步到从节点，从节点接收并应用这些变更，从而保证数据的一致性。

- **优点**：实现简单，通过读写分离可以提高系统的并发处理能力；从节点可以作为主节点的备份，当主节点出现故障时，可以手动将从节点提升为主节点。

- **缺点**：主从复制默认采用异步复制方式，可能会导致主从节点之间的数据不一致；不具备自动故障转移能力，需要人工干预来处理主节点故障。

#### 哨兵模式

- **原理**：哨兵模式是在主从复制的基础上增加了哨兵节点。哨兵节点负责监控主从节点的状态，当发现主节点出现故障时，会自动进行故障转移，将一个从节点提升为主节点，并通知其他从节点和客户端新的主节点地址。

- **优点**：具备自动故障转移能力，提高了系统的可用性；可以动态管理主从节点的配置信息，客户端无需手动修改配置。

- **缺点**：仍然存在数据不一致的风险，尤其是在主从切换期间；哨兵节点本身也存在单点故障问题，需要部署多个哨兵节点来提高可靠性。

#### 集群模式

- **原理**：Redis 集群采用哈希槽分区算法将整个数据库分为 16384 个哈希槽，每个节点负责一部分哈希槽。客户端可以直接连接任意一个节点进行读写操作，节点会根据哈希槽的分布情况将请求转发到正确的节点上。集群中的每个节点都有一个或多个从节点，用于实现主从复制和故障转移。

- **优点**：具备高可用性和可扩展性，可以自动进行数据分片和负载均衡；支持自动故障转移，当主节点出现故障时，会自动将从节点提升为主节点；可以动态添加或删除节点，方便集群的扩展和收缩。

- **缺点**：配置和管理相对复杂；某些复杂操作（如跨节点的事务、Lua 脚本等）可能受到限制。

### 具体的集群模式展开

#### 数据分片

- **哈希槽分区**：Redis 集群使用哈希槽分区算法将数据分散存储在多个节点上。每个节点负责一部分哈希槽，默认情况下，每个节点平均分配约 800 个哈希槽。当客户端进行写操作时，会根据 key 的哈希值计算出对应的哈希槽，然后将数据存储到负责该哈希槽的节点上。

- **数据迁移**：当集群需要扩展或收缩时，需要进行数据迁移。例如，当添加一个新节点时，需要从其他节点上迁移一部分哈希槽到新节点上；当删除一个节点时，需要将该节点负责的哈希槽迁移到其他节点上。Redis 集群支持在线数据迁移，迁移过程中不会影响集群的正常运行。

#### 节点通信

- **Gossip 协议**：Redis 集群使用 Gossip 协议进行节点间的通信。每个节点会定期向其他节点发送消息，消息内容包括节点的状态、哈希槽的分布情况等。通过 Gossip 协议，节点可以了解集群中其他节点的状态和拓扑结构，从而实现自动发现和动态更新。

- **故障检测**：节点通过 Gossip 协议互相发送 PING 消息来检测其他节点的状态。如果一个节点在一定时间内没有收到其他节点的响应，会将该节点标记为疑似下线（PFAIL）；当多个节点都将某个节点标记为疑似下线时，会将该节点标记为已下线（FAIL），并触发故障转移机制。

#### 故障转移

- **从节点选举**：当主节点被标记为已下线时，集群会从该主节点的从节点中选举一个新的主节点。选举过程基于一定的规则，如从节点的优先级、复制偏移量等。优先级较高的从节点会更有机会被选中；如果优先级相同，则复制偏移量最大的从节点会被优先考虑。

- **故障恢复**：选举出的新主节点会接管原主节点负责的哈希槽，并开始处理客户端的请求。其他从节点会停止复制原主节点，并开始复制新的主节点。整个故障转移过程通常在几秒钟内完成，对客户端的影响较小。

#### 客户端访问

- **直连模式**：客户端可以直接连接任意一个节点进行读写操作。当客户端操作的 key 所在的哈希槽不在该节点上时，节点会返回一个 MOVED 或 ASK 错误，指示客户端重定向到正确的节点上。

- **智能客户端**：为了提高客户端的访问效率，一些 Redis 客户端支持智能客户端模式。智能客户端会缓存哈希槽的分布情况，直接将请求发送到正确的节点上，避免了多次重定向的开销。
