# Redis

## 概述

Redis 是基于内存的高性能键值存储系统，数据默认存储在内存中。然而，内存具有易失性（如宕机、断电会导致数据丢失），因此 Redis 提供了**持久化机制**，将内存数据同步到磁盘，确保故障后数据可恢复。

包括：AOF（），RDB 快照两种方式。

- **核心目标**：平衡内存性能与数据可靠性，在性能损耗可控的前提下，最大限度减少数据丢失。
- 两种持久化方案
  1. **RDB（Redis Database Snapshot，快照持久化）**
  2. **AOF（Append Only File，日志持久化）**

## RDB 

#### **配置方案**

- **编辑配置文件**：找到 Redis 配置文件 `redis.conf` 并使用文本编辑器打开。
- **设置自动快照规则**：确定在多长时间内有多少次写操作时触发快照。
- **指定 RDB 文件存储信息**：设置 RDB 文件的存储目录和文件名。
- **选择压缩与校验选项**：根据需求决定是否开启文件压缩和校验功能。
- **保存配置并重启服务**：保存修改后的配置文件，重启 Redis 使配置生效。

```txt
# RDB 相关配置
# 自动触发快照规则，900 秒内有 1 次写操作、300 秒内有 10 次写操作、60 秒内有 10000 次写操作时触发
save 900 1
save 300 10
save 60 10000
# RDB 文件存储目录
dir /var/lib/redis
# RDB 文件名
dbfilename dump.rdb
# 开启 RDB 文件压缩
rdbcompression yes
# 开启 RDB 文件校验
rdbchecksum yes
```





#### **原理与流程**

- **全量备份**：将某一时刻的内存数据**全量快照**为二进制文件（`.rdb`），存储到磁盘。
- 触发方式
  - **手动触发**：执行 `SAVE`（阻塞主线程）或 `BGSAVE`（fork 子进程异步执行）命令。
  - **自动触发**：通过配置 `redis.conf` 中的 `save` 规则（如 `save 900 1` 表示 900 秒内至少 1 次写操作则触发快照）。
- 执行流程
  1. 父进程 fork 出子进程，子进程负责将内存数据写入临时 RDB 文件。
  2. 父进程继续处理客户端请求，子进程完成写入后，用临时文件替换旧的 RDB 文件。

#### **优缺点**

| **优点**                                                     | **缺点**                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 备份文件体积小（二进制压缩），便于远程传输和冷备份。 2. 恢复速度快（直接加载二进制文件到内存）。 | 1. 无法实时持久化，可能丢失最后一次快照后的数据（如设置 `save 60 100`，若 59 秒内写入数据未触发快照，故障时会丢失）。 2. fork 子进程时会占用双倍内存，可能导致 OOM（内存不足）。 |

#### **适用场景**

- 定期全量备份（如每天一次），用于灾难恢复或数据归档。
- 读多写少、允许少量数据丢失的场景（如缓存非核心数据）。

## AOF

#### 配置过程

- **编辑配置文件**：打开 `redis.conf`。
- **开启 AOF 持久化**：将 `appendonly` 设置为 `yes`。
- **指定 AOF 文件存储信息**：设置 AOF 文件的文件名。
- **选择同步策略**：根据性能和数据安全需求选择合适的同步策略。
- **设置日志重写规则**：配置触发 AOF 日志重写的条件。
- **保存配置并重启服务**：保存修改后重启 Redis。

```txt
# AOF 相关配置
# 开启 AOF 持久化
appendonly yes
# AOF 文件名
appendfilename "appendonly.aof"
# AOF 同步策略，每秒同步一次
appendfsync everysec
# AOF 日志重写规则，文件大小比上次重写后增长 100% 且至少 64MB 时触发
auto-aof-rewrite-percent 100
auto-aof-rewrite-min-size 64mb
```

#### **原理与流程**

- **增量记录**：实时将**写命令**（如 `SET`、`DEL`）以文本形式追加到 AOF 文件末尾，恢复时通过重放命令重建数据。

- 持久化策略
  通过 appendfsync配置：
  - **always**：每个写命令都同步到磁盘，数据安全性最高，但性能最低（约 1000 次 / 秒）。
  - **everysec**（默认）：每秒同步一次磁盘，兼顾性能与安全性（最多丢失 1 秒数据）。
  - **no**：由操作系统决定何时同步，性能最高，但数据丢失风险最大。
  
- 日志重写（AOF Rewrite）

  - 避免文件膨胀：随着写操作增加，AOF 文件会记录大量冗余命令（如多次修改同一 key），通过 `BGREWRITEAOF` 命令异步重写日志，用最简命令（如最终 `SET key value`）替代历史命令。
  - 触发条件：文件体积超过阈值（如比上次重写后增长 100% 且大于 64MB）。

##### **优缺点**

| **优点**                                                     | **缺点**                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 实时持久化（`always` 或 `everysec` 策略），数据丢失风险低。 2. 日志文件可读性强（文本格式），便于排查问题。 | 1. 相同数据下，文件体积通常大于 RDB（需定期重写）。 2. 恢复时需重放所有命令，速度慢于 RDB。 |

##### **适用场景**

- 对数据实时性要求高的场景（如计数器、实时库存扣减）。
- 写操作频繁、不能接受数据丢失的业务（如金融交易、用户余额管理）。



#### 文件内容：

**默认文件夹结构：**

```txt
/home/redis/         # 自定义根目录
  ├─ conf/           # 配置文件目录
  │  └─ redis.conf  
  ├─ data/           # 数据存储目录
  │  ├─ rdb/         # RDB文件专用目录
  │  │  └─ dump-01.rdb
  │  └─ aof/         # AOF文件专用目录
  │     └─ appendonly-01.aof
  └─ logs/           # 日志目录
     └─ redis.log
```

RDB:
二进制数据，通过Redis 工具输出：

```txt
[54321] 01 Apr 00:00:00 * RDB file version 0009
[54321] 01 Apr 00:00:00 * Checksum OK
[54321] 01 Apr 00:00:00 * 3 keys loaded
[54321] 01 Apr 00:00:00 * 0 expires
```





AOF: 

```txt
*3
$3
SET
$4
name
$4
John
*3
$3
SET
$3
age
$2
30
*5
$4
SADD
$6
fruits
$5
apple
$6
banana
$6
cherry
```



## 比较

