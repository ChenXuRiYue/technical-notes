# 三色标记法

## 1. 三色标记法与引用分析法的区别（补充：写屏障详解）

### 1.1 概述
三色标记法通过颜色状态（白色、灰色、黑色）支持并发 GC，写屏障是核心机制，协调应用线程与 GC 线程，减少 STW 时间。

### 1.2 引用分析法
- **定义**：从 GC Roots 遍历引用链，标记可达对象为存活。
- **工作方式**：单次遍历，需 STW 保证一致性。
- **特点**：简单，无并发支持。
- **样例**：  
  ```java
  Object a = new Object(); // GC Root
  a = null;               // GC 遍历，对象不可达回收
  ```

### 1.3 三色标记法
- **定义**：引入白色（未访问）、灰色（待扫描）、黑色（已扫描），支持并发标记。
- **工作方式**：初始标记（STW） + 并发标记（写屏障记录变化） + 重新标记（STW）。
- **特点**：减少 STW，支持并发。
- **样例**：  
  ```java
  Object a = new Object(); // 灰色
  Object b = new Object(); // 白色
  a = b;                  // 写屏障记录，b 变灰色
  ```

### 1.4 写屏障
- **定义**：应用线程修改引用时触发的逻辑，记录变化，确保标记正确。
- **作用**：防止漏标，协调并发。
- **工作原理**：
  - **SATB**：记录初始快照，保护老引用。  
    样例：`a = b; // b 被记录，确保存活`
  - **Incremental Update**：记录新引用，动态调整。  
    样例：`a.field = b; // b 变灰色，a 重新扫描`
- **执行**：记录到标记栈，GC 重新标记时处理。
- **样例**：  
  ```java
  class Node { Object field; }
  Node root = new Node();    // 黑色
  Object child = new Object(); // 白色
  root.field = child;        // 写屏障记录，child 变灰色
  ```

### 1.5 区别
- **目的**：  
  - 引用分析法：准确标记存活对象。  
  - 三色标记法：减少 STW，提高并发性。
- **并发性**：  
  - 引用分析法：需全程 STW。  
  - 三色标记法：写屏障支持并发，仅短暂 STW。

---

### 备注
- **STW**：暂停应用线程。
- **漏标**：存活对象未标记，可能误回收。